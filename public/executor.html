<!DOCTYPE html>
<html lang="uk">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Center - –í–∏–∫–æ–Ω–∞–≤–µ—Ü—å</title>
    <style>
        :root {
            --primary: #6366f1;
            --primary-dark: #4f46e5;
            --bg: #0f172a;
            --surface: #1e293b;
            --surface-light: #334155;
            --text: #f1f5f9;
            --text-muted: #94a3b8;
            --success: #22c55e;
            --warning: #f59e0b;
            --danger: #ef4444;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0;
            padding: 16px;
        }

        .container-centered {
            max-width: 400px;
            margin: 0 auto;
            padding: 16px;
        }

        .repairs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 12px;
        }

        .card {
            background: var(--surface);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
        }

        h1,
        h2 {
            margin-bottom: 16px;
        }

        h1 {
            font-size: 1.5rem;
            text-align: center;
        }

        h2 {
            font-size: 1.2rem;
            color: var(--text-muted);
        }

        input,
        select,
        button {
            width: 100%;
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 12px;
        }

        input,
        select {
            background: var(--surface-light);
            color: var(--text);
        }

        button {
            background: var(--primary);
            color: white;
            cursor: pointer;
            font-weight: 600;
        }

        button:hover {
            background: var(--primary-dark);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-logout {
            background: var(--danger);
            padding: 8px 16px;
            width: auto;
            font-size: 0.9rem;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .user-info {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .repair-card {
            background: var(--surface-light);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .repair-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .receipt-id {
            font-weight: 700;
            color: var(--primary);
            font-size: 1.1rem;
        }

        .status-badge {
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-1 {
            background: #fbbf24;
            color: #000;
        }

        /* –£ —á–µ—Ä–∑—ñ */
        .status-2 {
            background: #3b82f6;
            color: #fff;
        }

        /* –£ —Ä–æ–±–æ—Ç—ñ */
        .status-3 {
            background: #f97316;
            color: #fff;
        }

        /* –û—á—ñ–∫—É–≤–∞–Ω–Ω—è */
        .status-4 {
            background: #22c55e;
            color: #fff;
        }

        /* –ì–æ—Ç–æ–≤–∏–π */
        .status-5 {
            background: #ef4444;
            color: #fff;
        }

        /* –ù–µ –¥–æ–¥–∑–≤–æ–Ω–∏–ª–∏—Å—å */
        .status-6 {
            background: #64748b;
            color: #fff;
        }

        /* –í–∏–¥–∞–Ω–æ */
        .device-name {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .client-info {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .repair-details {
            margin-top: 12px;
            font-size: 0.9rem;
        }

        .repair-actions {
            margin-top: 12px;
            display: flex;
            gap: 8px;
        }

        .repair-actions select,
        .repair-actions button {
            margin-bottom: 0;
            width: auto;
            flex: 1;
        }

        .salary-card {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .salary-item {
            background: var(--surface-light);
            padding: 16px;
            border-radius: 8px;
            text-align: center;
        }

        .salary-item .value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--success);
        }

        .salary-item .label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 16px;
        }

        .tab {
            flex: 1;
            padding: 12px;
            background: var(--surface);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
        }

        .tab.active {
            background: var(--primary);
        }

        .hidden {
            display: none;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .error {
            background: var(--danger);
            color: white;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
        }

        .empty {
            text-align: center;
            padding: 40px;
            color: var(--text-muted);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--surface);
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        }
    </style>
</head>

<body>
    <!-- Login Screen -->
    <div id="login-screen" class="container-centered">
        <div class="card">
            <h1>üîß Service Center</h1>
            <h2 style="text-align: center; margin-bottom: 24px;">–í—Ö—ñ–¥ –¥–ª—è –≤–∏–∫–æ–Ω–∞–≤—Ü—è</h2>
            <div id="login-error" class="error hidden"></div>
            <select id="executor-select">
                <option value="">–û–±–µ—Ä—ñ—Ç—å –≤–∏–∫–æ–Ω–∞–≤—Ü—è...</option>
            </select>
            <input type="password" id="password-input" placeholder="–ü–∞—Ä–æ–ª—å">
            <button id="login-btn">–£–≤—ñ–π—Ç–∏</button>
            <p style="text-align: center; color: var(--text-muted); font-size: 0.8rem; margin-top: 12px;">
                –ü–µ—Ä—à–∏–π –≤—Ö—ñ–¥? –í–≤–µ–¥—ñ—Ç—å –±—É–¥—å-—è–∫–∏–π –ø–∞—Ä–æ–ª—å ‚Äî –≤—ñ–Ω —Å—Ç–∞–Ω–µ –≤–∞—à–∏–º –ø–∞—Ä–æ–ª–µ–º.
            </p>
        </div>
    </div>

    <!-- Main App -->
    <div id="app-screen" class="container hidden">
        <div class="header">
            <div class="user-info"><span id="user-name"></span></div>
            <div style="display: flex; gap: 8px;">
                <button class="btn-logout" id="change-pass-btn"
                    style="background: var(--surface-light); color: var(--text);">–ü–∞—Ä–æ–ª—å</button>
                <button class="btn-logout" id="logout-btn">–í–∏–π—Ç–∏</button>
            </div>
        </div>

        <!-- Password Change Modal -->
        <div id="password-modal" class="modal">
            <div class="modal-content">
                <h3>–ó–º—ñ–Ω–∏—Ç–∏ –ø–∞—Ä–æ–ª—å</h3>
                <div style="margin-top: 16px;">
                    <label style="display: block; margin-bottom: 4px; font-size: 0.9rem;">–°—Ç–∞—Ä–∏–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="old-pass-input" style="width: 100%; margin-bottom: 12px;">

                    <label style="display: block; margin-bottom: 4px; font-size: 0.9rem;">–ù–æ–≤–∏–π –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="new-pass-input" style="width: 100%; margin-bottom: 12px;">

                    <label style="display: block; margin-bottom: 4px; font-size: 0.9rem;">–ü—ñ–¥—Ç–≤–µ—Ä–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å</label>
                    <input type="password" id="confirm-pass-input" style="width: 100%; margin-bottom: 20px;">

                    <div style="display: flex; gap: 12px;">
                        <button id="save-pass-btn" style="flex: 1;">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                        <button id="cancel-pass-btn"
                            style="flex: 1; background: var(--surface-light);">–°–∫–∞—Å—É–≤–∞—Ç–∏</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Repairs Tab -->
        <div id="tab-repairs">
            <!-- Search Filters (visible for 0/0 users) -->
            <div id="search-filters" class="card hidden" style="margin-bottom: 24px;">
                <div
                    style="display: flex; gap: 12px; flex-wrap: wrap; align-items: center; justify-content: flex-start;">
                    <input type="text" id="filter-search" placeholder="–ü–æ—à—É–∫ (Enter)..."
                        style="width: 240px; flex: 0 0 auto;">
                    <select id="filter-status" style="width: 180px; flex: 0 0 auto;">
                        <option value="">–°—Ç–∞—Ç—É—Å</option>
                        <option value="1">–£ —á–µ—Ä–∑—ñ</option>
                        <option value="2">–£ —Ä–æ–±–æ—Ç—ñ</option>
                        <option value="3">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è</option>
                        <option value="4">–ì–æ—Ç–æ–≤–∏–π</option>
                        <option value="5">–ù–µ –¥–æ–¥–∑–≤–æ–Ω–∏–ª–∏—Å—è</option>
                        <option value="6">–í–∏–¥–∞–Ω–æ</option>
                    </select>
                    <button id="filter-clear-btn"
                        style="display: none; width: 240px; background: var(--surface-light); flex: 0 0 auto;">‚úï
                        –û—á–∏—Å—Ç–∏—Ç–∏ —Ñ—ñ–ª—å—Ç—Ä–∏</button>
                </div>
            </div>
            <div id="repairs-loading" class="loading">–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è...</div>
            <div id="repairs-list" class="repairs-grid"></div>
            <div id="repairs-empty" class="empty hidden">–ù–µ–º–∞—î –∑–∞–º–æ–≤–ª–µ–Ω—å</div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let token = localStorage.getItem('executor_token');
        let user = null;
        let isLimitedWorker = false;
        let isFullAccess = false;

        const statusNames = {
            1: '–£ —á–µ—Ä–∑—ñ',
            2: '–£ —Ä–æ–±–æ—Ç—ñ',
            3: '–û—á—ñ–∫—É–≤–∞–Ω–Ω—è',
            4: '–ì–æ—Ç–æ–≤–∏–π',
            5: '–ù–µ –¥–æ–¥–∑–≤–æ–Ω–∏–ª–∏—Å—å',
            6: '–í–∏–¥–∞–Ω–æ',
            7: '–û–¥–µ—Å–∞'
        };

        async function api(endpoint, options = {}) {
            const headers = { 'Content-Type': 'application/json' };
            if (token) headers['Authorization'] = `Bearer ${token}`;

            const res = await fetch(`${API_BASE}${endpoint}`, { ...options, headers });
            const data = await res.json();

            if (res.status === 401) {
                logout();
                throw new Error('Unauthorized');
            }
            if (!res.ok) throw new Error(data.error || 'Error');
            return data;
        }

        async function loadExecutors() {
            try {
                const { data } = await api('/api/executors/list');
                const select = document.getElementById('executor-select');
                data.forEach(e => {
                    const opt = document.createElement('option');
                    opt.value = e.name;
                    opt.textContent = e.name;
                    select.appendChild(opt);
                });
            } catch (e) {
                console.error('Failed to load executors:', e);
            }
        }

        async function login() {
            const name = document.getElementById('executor-select').value;
            const password = document.getElementById('password-input').value;
            const errorEl = document.getElementById('login-error');

            if (!name || !password) {
                errorEl.textContent = '–í–∏–±–µ—Ä—ñ—Ç—å –≤–∏–∫–æ–Ω–∞–≤—Ü—è —Ç–∞ –≤–≤–µ–¥—ñ—Ç—å –ø–∞—Ä–æ–ª—å';
                errorEl.classList.remove('hidden');
                return;
            }

            try {
                const res = await api('/api/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ name, password })
                });

                token = res.token;
                user = res.user;
                localStorage.setItem('executor_token', token);

                showApp();
            } catch (e) {
                errorEl.textContent = '–ù–µ–≤—ñ—Ä–Ω–∏–π –ø–∞—Ä–æ–ª—å';
                errorEl.classList.remove('hidden');
            }
        }

        function logout() {
            token = null;
            user = null;
            localStorage.removeItem('executor_token');
            document.getElementById('login-screen').classList.remove('hidden');
            document.getElementById('app-screen').classList.add('hidden');
        }

        async function showApp() {
            document.getElementById('login-screen').classList.add('hidden');
            document.getElementById('app-screen').classList.remove('hidden');

            try {
                const { user: userData } = await api('/api/auth/me');
                user = userData;
                document.getElementById('user-name').textContent = user.executorName;

                // Check if limited worker (salary > 0)
                const salaryPercent = user.salaryPercent || 0;
                const productsPercent = user.productsPercent || 0;
                isLimitedWorker = salaryPercent > 0;
                isFullAccess = salaryPercent === 0 && productsPercent === 0;

                // Show search filters for fullAccess users
                const searchFilters = document.getElementById('search-filters');
                if (isFullAccess && searchFilters) {
                    searchFilters.classList.remove('hidden');
                }
            } catch (e) {
                logout();
                return;
            }

            loadRepairs();
        }

        async function loadRepairs() {
            const listEl = document.getElementById('repairs-list');
            const loadingEl = document.getElementById('repairs-loading');
            const emptyEl = document.getElementById('repairs-empty');

            loadingEl.classList.remove('hidden');
            listEl.innerHTML = '';
            emptyEl.classList.add('hidden');

            try {
                // Build query params
                let queryParams = 'limit=100';
                if (isFullAccess) {
                    const search = document.getElementById('filter-search')?.value;
                    const filterStatus = document.getElementById('filter-status')?.value;

                    if (search) queryParams += `&search=${encodeURIComponent(search)}`;
                    if (filterStatus) queryParams += `&filterStatus=${filterStatus}`;
                }

                const response = await api(`/api/my/repairs?${queryParams}`);
                const { data } = response;
                // Update global flags from response
                if (response.isLimitedWorker !== undefined) {
                    isLimitedWorker = response.isLimitedWorker;
                }
                if (response.isFullAccess !== undefined) {
                    isFullAccess = response.isFullAccess;
                }

                loadingEl.classList.add('hidden');

                if (data.length === 0) {
                    emptyEl.classList.remove('hidden');
                    return;
                }

                data.forEach(repair => {
                    listEl.appendChild(createRepairCard(repair, isLimitedWorker));
                });
            } catch (e) {
                loadingEl.textContent = '–ü–æ–º–∏–ª–∫–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è';
            }
        }

        function createRepairCard(repair, limited = false) {
            const div = document.createElement('div');
            div.className = 'repair-card';

            if (limited) {
                // Limited worker view - only device, fault, notes (read-only), workDone (editable)
                div.innerHTML = `
                    <div class="repair-header">
                        <span class="receipt-id">#${repair.receiptId || repair.id}</span>
                        <span class="status-badge status-${repair.status}">${statusNames[repair.status] || '–ù–µ–≤—ñ–¥–æ–º–æ'}</span>
                    </div>
                    <div class="device-name">${repair.deviceName || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</div>
                    <div class="repair-details">
                        <strong>–ù–µ—Å–ø—Ä–∞–≤–Ω—ñ—Å—Ç—å:</strong> ${repair.faultDesc || '‚Äî'}<br>
                        <strong>–ü—Ä–∏–º—ñ—Ç–∫–∏:</strong> ${repair.note || '‚Äî'}
                    </div>
                    <div style="margin-top: 12px;">
                        <label style="font-size: 0.9rem; color: var(--text-muted);">–í–∏–∫–æ–Ω–∞–Ω–Ω—è —Ä–æ–±–æ—Ç–∏:</label>
                        <textarea 
                            id="workDone-${repair.id}" 
                            style="width: 100%; min-height: 80px; background: var(--surface); color: var(--text); border: 1px solid var(--surface-light); border-radius: 8px; padding: 8px; margin-top: 4px; resize: vertical;"
                        >${repair.workDone || ''}</textarea>
                        <button onclick="saveWorkDone(${repair.id})" style="margin-top: 8px;">–ó–±–µ—Ä–µ–≥—Ç–∏</button>
                    </div>
                `;
            } else {
                // Full view (0/0 users) - can only edit isPaid
                const workDoneText = repair.workDone || '‚Äî';
                const faultText = repair.faultDesc || '‚Äî';
                const hasWorkDone = repair.workDone && repair.workDone.length > 30;
                const hasFault = repair.faultDesc && repair.faultDesc.length > 30;

                div.style.display = 'flex';
                div.style.flexDirection = 'column';
                div.style.height = '100%';

                div.innerHTML = `
                    <div class="repair-header">
                        <span class="receipt-id">#${repair.receiptId || repair.id}</span>
                        <span class="status-badge status-${repair.status}">${statusNames[repair.status] || '–ù–µ–≤—ñ–¥–æ–º–æ'}</span>
                    </div>
                    <div class="device-name" style="color: var(--primary);">${repair.deviceName || '–ë–µ–∑ –Ω–∞–∑–≤–∏'}</div>
                    <div class="client-info" style="color: #60a5fa;">${repair.clientName || ''} ‚Ä¢ ${repair.clientPhone || ''}</div>
                    <div class="repair-details" style="flex: 1;">
                        ${hasFault ? `
                            <details style="margin-bottom: 4px;">
                                <summary style="color: var(--warning); cursor: pointer;"><strong>–ù–µ—Å–ø—Ä–∞–≤–Ω—ñ—Å—Ç—å</strong></summary>
                                <div style="margin-top: 4px; padding-left: 8px;">${faultText}</div>
                            </details>
                        ` : `
                            <div style="margin-bottom: 4px;"><span style="color: var(--warning);"><strong>–ù–µ—Å–ø—Ä–∞–≤–Ω—ñ—Å—Ç—å:</strong></span> ${faultText}</div>
                        `}
                        ${hasWorkDone ? `
                            <details style="margin-bottom: 4px;">
                                <summary style="color: #a78bfa; cursor: pointer;"><strong>–í–∏–∫–æ–Ω–∞–Ω–æ</strong></summary>
                                <div style="margin-top: 4px; padding-left: 8px;">${workDoneText}</div>
                            </details>
                        ` : `
                            <div style="margin-bottom: 4px;"><span style="color: #a78bfa;"><strong>–í–∏–∫–æ–Ω–∞–Ω–æ:</strong></span> ${workDoneText}</div>
                        `}
                        <div><span style="color: var(--success);"><strong>–°—É–º–∞:</strong> ${repair.totalCost || 0} –≥—Ä–Ω</span></div>
                    </div>
                    <div style="margin-top: auto; padding-top: 8px;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" 
                                id="isPaid-${repair.id}" 
                                ${repair.isPaid ? 'checked' : ''} 
                                onchange="updateIsPaid(${repair.id}, this.checked)"
                                style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="color: ${repair.isPaid ? 'var(--success)' : 'var(--danger)'}; font-weight: 600; font-size: 0.9rem;">
                                ${repair.isPaid ? '–û–ø–ª–∞—á–µ–Ω–æ' : '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ'}
                            </span>
                        </label>
                    </div>
                `;
            }
            return div;
        }

        // Toast notification system
        function showToast(message, type = 'success') {
            // Remove existing toast
            const existing = document.querySelector('.toast-notification');
            if (existing) existing.remove();
            
            const toast = document.createElement('div');
            toast.className = 'toast-notification';
            toast.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 12px 20px;
                background: ${type === 'success' ? 'var(--success)' : 'var(--danger)'};
                color: white;
                border-radius: 8px;
                font-weight: 500;
                z-index: 9999;
                animation: slideIn 0.3s ease-out;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.animation = 'slideOut 0.3s ease-out forwards';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }
        
        // Add toast animation styles
        const toastStyles = document.createElement('style');
        toastStyles.textContent = `
            @keyframes slideIn {
                from { transform: translateX(100%); opacity: 0; }
                to { transform: translateX(0); opacity: 1; }
            }
            @keyframes slideOut {
                from { transform: translateX(0); opacity: 1; }
                to { transform: translateX(100%); opacity: 0; }
            }
        `;
        document.head.appendChild(toastStyles);
        
        // Debounce timers for auto-save
        const saveTimers = {};
        
        async function updateIsPaid(id, isPaid) {
            // Immediate UI update
            const checkbox = document.getElementById(`isPaid-${id}`);
            const label = checkbox?.parentElement?.querySelector('span');
            if (label) {
                label.textContent = isPaid ? '–û–ø–ª–∞—á–µ–Ω–æ' : '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ';
                label.style.color = isPaid ? 'var(--success)' : 'var(--danger)';
            }
            
            try {
                await api(`/api/my/repairs/${id}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ isPaid })
                });
                showToast(isPaid ? '–û–ø–ª–∞—á–µ–Ω–æ ‚úì' : '–°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª–µ–Ω–æ');
            } catch (e) {
                // Revert on error
                if (checkbox) checkbox.checked = !isPaid;
                if (label) {
                    label.textContent = !isPaid ? '–û–ø–ª–∞—á–µ–Ω–æ' : '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ';
                    label.style.color = !isPaid ? 'var(--success)' : 'var(--danger)';
                }
                showToast('–ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
            }
        }

        function saveWorkDone(id) {
            const textarea = document.getElementById(`workDone-${id}`);
            const workDone = textarea.value;
            
            // Show saving indicator
            const btn = textarea.parentElement?.querySelector('button');
            if (btn) {
                btn.textContent = '–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...';
                btn.disabled = true;
            }

            // Clear existing timer for this id
            if (saveTimers[id]) clearTimeout(saveTimers[id]);
            
            // Debounced save
            saveTimers[id] = setTimeout(async () => {
                try {
                    await api(`/api/my/repairs/${id}/status`, {
                        method: 'PUT',
                        body: JSON.stringify({ workDone })
                    });
                    showToast('–ó–±–µ—Ä–µ–∂–µ–Ω–æ ‚úì');
                    if (btn) {
                        btn.textContent = '–ó–±–µ—Ä–µ–≥—Ç–∏';
                        btn.disabled = false;
                    }
                } catch (e) {
                    showToast('–ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
                    if (btn) {
                        btn.textContent = '–ó–±–µ—Ä–µ–≥—Ç–∏';
                        btn.disabled = false;
                    }
                }
            }, 300);
        }
        
        // Auto-save workDone on input (debounced)
        function setupAutoSave(id) {
            const textarea = document.getElementById(`workDone-${id}`);
            if (!textarea || textarea.dataset.autoSaveSetup) return;
            textarea.dataset.autoSaveSetup = 'true';
            
            let autoSaveTimer = null;
            textarea.addEventListener('input', () => {
                if (autoSaveTimer) clearTimeout(autoSaveTimer);
                // Auto-save after 1.5 seconds of no typing
                autoSaveTimer = setTimeout(() => saveWorkDone(id), 1500);
            });
        }

        async function updateStatus(id) {
            const select = document.querySelector(`.status-select[data-id="${id}"]`);
            const status = parseInt(select.value);
            const oldStatus = select.dataset.oldValue;

            try {
                await api(`/api/my/repairs/${id}/status`, {
                    method: 'PUT',
                    body: JSON.stringify({ status })
                });
                // Update local state
                select.dataset.oldValue = status;
                
                // Update badge without full reload
                const card = select.closest('.repair-card');
                const badge = card?.querySelector('.status-badge');
                if (badge) {
                    badge.className = `status-badge status-${status}`;
                    badge.textContent = statusNames[status] || '–ù–µ–≤—ñ–¥–æ–º–æ';
                }
                showToast('–°—Ç–∞—Ç—É—Å –æ–Ω–æ–≤–ª–µ–Ω–æ ‚úì');
            } catch (e) {
                // Revert on error
                if (oldStatus) select.value = oldStatus;
                showToast('–ü–æ–º–∏–ª–∫–∞: ' + e.message, 'error');
            }
        }

        // Event listeners
        document.getElementById('login-btn').addEventListener('click', login);
        document.getElementById('logout-btn').addEventListener('click', logout);
        document.getElementById('password-input').addEventListener('keypress', e => {
            if (e.key === 'Enter') login();
        });

        // Password change logic
        const passModal = document.getElementById('password-modal');
        document.getElementById('change-pass-btn').addEventListener('click', () => {
            passModal.classList.add('active');
            document.getElementById('old-pass-input').value = '';
            document.getElementById('new-pass-input').value = '';
            document.getElementById('confirm-pass-input').value = '';
        });

        document.getElementById('cancel-pass-btn').addEventListener('click', () => {
            passModal.classList.remove('active');
        });

        document.getElementById('save-pass-btn').addEventListener('click', async () => {
            const oldPassword = document.getElementById('old-pass-input').value;
            const newPassword = document.getElementById('new-pass-input').value;
            const confirmPassword = document.getElementById('confirm-pass-input').value;

            if (!oldPassword || !newPassword) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –∑–∞–ø–æ–≤–Ω—ñ—Ç—å –≤—Å—ñ –ø–æ–ª—è');
                return;
            }

            if (newPassword !== confirmPassword) {
                alert('–ü–∞—Ä–æ–ª—ñ –Ω–µ —Å–ø—ñ–≤–ø–∞–¥–∞—é—Ç—å');
                return;
            }

            try {
                const response = await api('/api/auth/change-password', {
                    method: 'POST',
                    body: JSON.stringify({ oldPassword, newPassword })
                });

                alert(response.message || '–ü–∞—Ä–æ–ª—å –∑–º—ñ–Ω–µ–Ω–æ');
                passModal.classList.remove('active');
            } catch (e) {
                alert('–ü–æ–º–∏–ª–∫–∞: ' + e.message);
            }
        });

        // Search filter event listeners
        const searchInput = document.getElementById('filter-search');
        const statusSelect = document.getElementById('filter-status');
        const clearBtn = document.getElementById('filter-clear-btn');

        function updateClearBtnVisibility() {
            if (clearBtn) {
                const hasFilters = searchInput.value || statusSelect.value;
                clearBtn.style.display = hasFilters ? 'block' : 'none';
            }
        }

        searchInput?.addEventListener('input', updateClearBtnVisibility);
        statusSelect?.addEventListener('change', () => {
            updateClearBtnVisibility();
            loadRepairs();
        });

        searchInput?.addEventListener('keypress', e => {
            if (e.key === 'Enter') loadRepairs();
        });

        clearBtn?.addEventListener('click', () => {
            searchInput.value = '';
            statusSelect.value = '';
            updateClearBtnVisibility();
            loadRepairs();
        });

        // Init
        loadExecutors();
        if (token) {
            showApp();
        }
    </script>
</body>

</html>