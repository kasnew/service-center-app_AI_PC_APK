# Offline База Даних та Автоматична Синхронізація

## Огляд

Android додаток тепер підтримує:
- **Offline база даних** - початкова база даних включена в APK
- **Автоматична синхронізація** - синхронізація з сервером при наявності з'єднання
- **Моніторинг з'єднання** - автоматичне виявлення наявності інтернету

## Початкова База Даних (Pre-populated Database)

### Як це працює

1. База даних SQLite включається в APK в папці `app/src/main/assets/databases/service_center_db`
2. При першому запуску додатку, якщо локальної бази даних немає, Room автоматично копіює базу з assets
3. Далі додаток працює з локальною базою даних, яка синхронізується з сервером

### Експорт бази даних з Electron

Для включення поточної бази даних в APK:

```bash
cd android-app
./export-database.sh [path-to-electron-db]
```

Наприклад:
```bash
./export-database.sh ../1.sqlite
```

Скрипт скопіює базу даних з Electron проекту в `app/src/main/assets/databases/service_center_db`.

### Структура

```
android-app/
├── app/
│   └── src/
│       └── main/
│           └── assets/
│               └── databases/
│                   └── service_center_db  # Початкова база даних
```

### Важливо

- База даних повинна мати структуру, сумісну з Room Entity класами
- При зміні версії бази даних (version в AppDatabase), потрібно оновити початкову базу
- Якщо база даних не знайдена в assets, Room створить порожню базу
- **Поточна версія Room бази даних: 3** (додано поле `minQuantity` для контролю залишків)
- Повна документація схеми бази даних: [DATABASE_SCHEMA.md](../DATABASE_SCHEMA.md)

## Автоматична Синхронізація

### SyncManager

`SyncManager` автоматично синхронізує дані з сервером:

1. **Моніторинг з'єднання** - використовує `NetworkCallback` для відстеження наявності інтернету
2. **Автоматична синхронізація** - при з'явленні з'єднання автоматично запускає синхронізацію
3. **Інтервал синхронізації** - мінімальний інтервал між синхронізаціями: 5 хвилин
4. **Синхронізація при запуску** - при запуску додатку, якщо є з'єднання, виконується синхронізація

### Що синхронізується

- **Ремонти** (`RepairRepository.syncRepairs()`)
  - Завантаження всіх ремонтів з сервера
  - Видалення ремонтів, які були видалені на сервері
  - Оновлення існуючих ремонтів

- **Несинхронізовані ремонти** (`RepairRepository.syncUnsyncedRepairs()`)
  - Відправка ремонтів, створених в офлайн режимі

- **Склад** (`WarehouseRepository.syncWarehouseItems()`)
  - Завантаження товарів на складі

- **Транзакції** (`TransactionRepository.syncTransactions()`)
  - Завантаження транзакцій

### Ручна синхронізація

Для ручної синхронізації можна викликати:

```kotlin
syncManager.syncNow()
```

## Налаштування

### Вимоги

1. **Налаштований URL сервера** - в налаштуваннях додатку повинен бути вказаний URL сервера
2. **Дозвіл на інтернет** - в `AndroidManifest.xml` повинен бути дозвіл `INTERNET`

### Перевірка роботи

1. Запустіть додаток
2. Перевірте логи - повинні бути повідомлення від `SyncManager`
3. При наявності з'єднання та налаштованому URL, синхронізація виконається автоматично

## Логування

Для відстеження роботи синхронізації перевірте логи:

```bash
adb logcat | grep SyncManager
```

Основні події:
- `Network available` - з'єднання з'явилося
- `Starting sync` - початок синхронізації
- `Sync completed successfully` - успішна синхронізація
- `Sync error` - помилка синхронізації

## Troubleshooting

### База даних не копіюється з assets

- Перевірте, чи файл існує: `app/src/main/assets/databases/service_center_db`
- Перевірте права доступу до файлу
- Перевірте логи при запуску додатку

### Синхронізація не працює

1. Перевірте налаштування URL сервера
2. Перевірте наявність інтернету
3. Перевірте логи на наявність помилок
4. Перевірте, чи запущений синхронізаційний сервер в Electron додатку

### Синхронізація виконується занадто часто

- Мінімальний інтервал між синхронізаціями: 5 хвилин
- Можна змінити в `SyncManager.syncInterval`

## Майбутні покращення

- [ ] Додати налаштування інтервалу синхронізації
- [ ] Додати індикатор прогресу синхронізації в UI
- [ ] Додати конфлікт-резолюцію для одночасних змін
- [ ] Додати синхронізацію тільки змінених даних (incremental sync)





